<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CS182A/282A Special Participation Search Portal</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-cloud/1.2.5/d3.layout.cloud.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Serif', serif;
            background: #003262;
            min-height: 100vh;
            padding: 20px;
            font-size: 16px;
            color: #212529;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: #003262;
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .search-section {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .search-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .form-group label {
            font-weight: 700;
            margin-bottom: 10px;
            color: #003262;
            font-size: 16px;
        }

        .dropdown-container {
            position: relative;
        }

        .dropdown-display {
            padding: 14px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 16px;
            font-family: 'Source Sans Pro', sans-serif;
            background: white;
            cursor: pointer;
            min-height: 50px;
            display: flex;
            align-items: center;
            transition: border-color 0.3s;
            color: #212529;
            font-weight: 500;
        }

        .dropdown-display:hover,
        .dropdown-display.active {
            border-color: #FDB515;
        }

        .dropdown-placeholder {
            color: #868e96;
            font-weight: 400;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #FDB515;
            border-radius: 6px;
            margin-top: 4px;
            max-height: 250px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-controls {
            padding: 8px 12px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            flex-direction: column;
            gap: 8px;
            background: #f8f9fa;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .search-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 14px;
            font-family: 'Source Sans Pro', sans-serif;
            color: #495057;
        }

        .search-input:focus {
            outline: none;
            border-color: #FDB515;
            box-shadow: 0 0 0 2px rgba(253, 181, 21, 0.2);
        }

        .controls-row {
            display: flex;
            gap: 8px;
        }

        .control-btn {
            flex: 1;
            padding: 6px 10px;
            border: 1px solid #003262;
            background: white;
            color: #003262;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            font-family: 'Source Sans Pro', sans-serif;
            cursor: pointer;
            transition: all 0.2s;
        }

        .control-btn:hover {
            background: #003262;
            color: white;
        }

        .dropdown-item {
            padding: 10px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.2s;
        }

        .dropdown-item:hover {
            background: #f8f9fa;
        }

        .dropdown-item.disabled {
            opacity: 0.4;
            cursor: not-allowed;
            background: #f8f9fa;
        }

        .dropdown-item.disabled:hover {
            background: #f8f9fa;
        }

        .dropdown-item.hidden {
            display: none;
        }

        .loading {
            padding: 20px;
            text-align: center;
            color: #6c757d;
        }

        .error-message {
            padding: 20px;
            text-align: center;
            color: #dc3545;
            background: #f8d7da;
            border-radius: 6px;
            margin: 10px;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #003262;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .dropdown-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #003262;
        }

        .dropdown-item.disabled input[type="checkbox"] {
            cursor: not-allowed;
        }

        .dropdown-item label {
            cursor: pointer;
            flex: 1;
            font-weight: 400;
            color: #495057;
        }

        .dropdown-item.disabled label {
            cursor: not-allowed;
        }

        .selected-count {
            background: #003262;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }

        .search-actions {
            display: flex;
            gap: 10px;
        }

        .search-btn {
            background: #003262;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            font-family: 'Source Sans Pro', sans-serif;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 50, 98, 0.4);
        }

        .clear-btn {
            background: #FDB515;
            color: #003262;
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            font-family: 'Source Sans Pro', sans-serif;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .clear-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(253, 181, 21, 0.4);
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: transparent;
            border: none;
            font-size: 16px;
            font-weight: 600;
            font-family: 'Source Sans Pro', sans-serif;
            color: #6c757d;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab.active {
            background: white;
            color: #003262;
            border-bottom: 3px solid #FDB515;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .content {
            padding: 30px;
            min-height: 400px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .summary-view {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .summary-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #003262;
            max-height: 80vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .summary-card h3 {
            color: #003262;
            margin-bottom: 15px;
            font-weight: 700;
            flex-shrink: 0;
        }

        .summary-text {
            line-height: 1.8;
            color: #495057;
            padding: 10px;
            flex: 1;
            overflow-y: auto;
        }
        
        /* Ed post content styles */
        .ed-post-content h1 { font-size: 1.6em; font-weight: 700; color: #003262; margin: 18px 0 12px 0; }
        .ed-post-content h2 { font-size: 1.35em; font-weight: 700; color: #003262; margin: 16px 0 10px 0; border-bottom: 2px solid #FDB515; padding-bottom: 5px; }
        .ed-post-content h3 { font-size: 1.15em; font-weight: 600; color: #003262; margin: 14px 0 8px 0; }
        .ed-post-content p { margin: 10px 0; line-height: 1.8; }
        .ed-post-content b, .ed-post-content strong { font-weight: 700; color: #003262; }
        .ed-post-content i, .ed-post-content em { font-style: italic; }
        .ed-post-content ul, .ed-post-content ol { margin: 12px 0; padding-left: 25px; }
        .ed-post-content li { margin: 6px 0; line-height: 1.7; }
        .ed-post-content a { color: #003262; text-decoration: underline; }
        .ed-post-content a:hover { color: #FDB515; }
        .ed-post-content code { font-family: monospace; background: #f4f4f4; padding: 2px 5px; border-radius: 3px; }
        .ed-post-content pre { background: #f4f4f4; padding: 12px; border-radius: 6px; overflow-x: auto; }
        .ed-post-content blockquote { border-left: 3px solid #FDB515; padding-left: 12px; margin: 12px 0; color: #6c757d; }
        .ed-post-content .amber-display-file { display: inline-flex; align-items: center; gap: 8px; padding: 8px 12px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; margin: 8px 0; }
        .ed-post-content .amber-display-file img { width: 20px; height: 20px; }
        .ed-post-content .amber-display-file a { text-decoration: none; font-weight: 600; }

        .pdf-viewer {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            min-height: 400px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            border: 2px dashed #dee2e6;
            overflow-y: auto;
        }

        .placeholder {
            text-align: center;
            color: #495057;
            font-size: 16px;
            font-weight: 500;
        }

        .filter-note {
            background: #FDB515;
            color: #003262;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
        }

        #wordcloud {
            width: 100%;
            height: 500px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        .sentiment-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .sentiment-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .sentiment-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }

        .sentiment-card.positive {
            border-left: 4px solid #28a745;
        }

        .sentiment-card.neutral {
            border-left: 4px solid #FDB515;
        }

        .sentiment-card.negative {
            border-left: 4px solid #dc3545;
        }

        .sentiment-score {
            font-size: 24px;
            font-weight: 700;
            margin: 10px 0;
            color: #003262;
        }

        .llm-name {
            font-weight: 600;
            color: #003262;
        }

        h3 {
            font-weight: 700;
        }

        .posts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .post-card {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 24px;
            box-shadow: 0 3px 12px rgba(0,0,0,0.12);
            transition: all 0.3s;
            cursor: pointer;
        }

        .post-card:hover {
            box-shadow: 0 6px 24px rgba(0,0,0,0.25);
            transform: translateY(-3px);
            border-color: #003262;
        }

        .post-card h3 {
            color: #003262;
            margin-bottom: 16px;
            font-size: 22px;
            font-weight: 700;
            line-height: 1.4;
        }

        .post-meta {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 15px;
            margin-bottom: 14px;
            flex-wrap: wrap;
        }

        .post-author {
            color: #212529;
            font-size: 16px;
            font-weight: 600;
        }

        .participation-badge {
            padding: 6px 14px;
            border-radius: 14px;
            font-size: 14px;
            font-weight: 700;
            color: #003262;
        }

        .participation-badge.a {
            background: #ffcccc;
        }

        .participation-badge.b {
            background: #fff4cc;
        }

        .participation-badge.c {
            background: #ccffcc;
        }

        .participation-badge.d {
            background: #cce5ff;
        }

        .participation-badge.e {
            background: #e5ccff;
        }

        .post-excerpt {
            color: #212529;
            line-height: 1.7;
            font-size: 16px;
            margin-bottom: 12px;
        }

        @media (max-width: 768px) {
            .summary-view {
                grid-template-columns: 1fr;
            }
            
            .search-grid {
                grid-template-columns: 1fr;
            }
            
            .posts-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>CS182/282A Special Participation Search Portal</h1>
            <p>Search and analyze special participation submissions across different LLM agents</p>
        </div>

        <div class="search-section">
            <div class="search-grid">
                <div class="form-group">
                    <label>Participation</label>
                    <div class="dropdown-container">
                        <div class="dropdown-display" onclick="toggleDropdown('participationDropdown')">
                            <span class="dropdown-placeholder" id="participationDisplay">Select participation...</span>
                        </div>
                        <div class="dropdown-menu" id="participationDropdown">
                            <div class="dropdown-controls">
                                <input type="text" class="search-input" placeholder="Search participation..." oninput="filterDropdown('participation', this.value)">
                                <div class="controls-row">
                                    <button class="control-btn" onclick="selectAll('participation')">Select All</button>
                                    <button class="control-btn" onclick="unselectAll('participation')">Unselect All</button>
                                </div>
                            </div>
                            <div class="dropdown-item">
                                <input type="checkbox" id="participation_a" value="A" onchange="updateDisplay('participation')">
                                <label for="participation_a">Participation A</label>
                            </div>
                            <div class="dropdown-item">
                                <input type="checkbox" id="participation_b" value="B" onchange="updateDisplay('participation')">
                                <label for="participation_b">Participation B</label>
                            </div>
                            <div class="dropdown-item">
                                <input type="checkbox" id="participation_c" value="C" onchange="updateDisplay('participation')">
                                <label for="participation_c">Participation C</label>
                            </div>
                            <div class="dropdown-item">
                                <input type="checkbox" id="participation_d" value="D" onchange="updateDisplay('participation')">
                                <label for="participation_d">Participation D</label>
                            </div>
                            <div class="dropdown-item">
                                <input type="checkbox" id="participation_e" value="E" onchange="updateDisplay('participation')">
                                <label for="participation_e">Participation E</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group" id="studentFormGroup">
                    <label>Author Name</label>
                    <div class="dropdown-container">
                        <div class="dropdown-display" onclick="toggleDropdown('studentDropdown')">
                            <span class="dropdown-placeholder" id="studentDisplay">Select author name...</span>
                        </div>
                        <div class="dropdown-menu" id="studentDropdown">
                            <div class="dropdown-controls">
                                <input type="text" class="search-input" placeholder="Search students..." oninput="filterDropdown('student', this.value)">
                                <div class="controls-row">
                                    <button class="control-btn" onclick="selectAll('student')">Select All</button>
                                    <button class="control-btn" onclick="unselectAll('student')">Unselect All</button>
                                </div>
                            </div>
                            <div id="studentDropdownItems" class="loading">
                                <div class="loading-spinner"></div>
                                <p style="margin-top: 10px;">Loading authors...</p>
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                            <div class="dropdown-item">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Homework Number</label>
                    <div class="dropdown-container">
                        <div class="dropdown-display" onclick="toggleDropdown('homeworkDropdown')">
                            <span class="dropdown-placeholder" id="homeworkDisplay">Select homework...</span>
                        </div>
                        <div class="dropdown-menu" id="homeworkDropdown">
                            <div class="dropdown-controls">
                                <input type="text" class="search-input" placeholder="Search homework..." oninput="filterDropdown('homework', this.value)">
                                <div class="controls-row">
                                    <button class="control-btn" onclick="selectAll('homework')">Select All</button>
                                    <button class="control-btn" onclick="unselectAll('homework')">Unselect All</button>
                                </div>
                            </div>
                            <div id="homeworkDropdownItems" class="loading">
                                <div class="loading-spinner"></div>
                                <p style="margin-top: 10px;">Loading homeworks...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>LLM Agent</label>
                    <div class="dropdown-container">
                        <div class="dropdown-display" onclick="toggleDropdown('llmDropdown')">
                            <span class="dropdown-placeholder" id="llmDisplay">Select LLM agents...</span>
                        </div>
                        <div class="dropdown-menu" id="llmDropdown">
                            <div class="dropdown-controls">
                                <input type="text" class="search-input" placeholder="Search LLM agents..." oninput="filterDropdown('llm', this.value)">
                                <div class="controls-row">
                                    <button class="control-btn" onclick="selectAll('llm')">Select All</button>
                                    <button class="control-btn" onclick="unselectAll('llm')">Unselect All</button>
                                </div>
                            </div>
                            <div id="llmDropdownItems" class="loading">
                                <div class="loading-spinner"></div>
                                <p style="margin-top: 10px;">Loading LLM agents...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="search-actions">
                <button class="search-btn" onclick="handleSearch()">Search</button>
                <button class="clear-btn" onclick="clearAllSelections()">Clear All Selections</button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('posts')">Posts</button>
            <button class="tab" onclick="switchTab('summary')">Post Previewer</button>
            <button class="tab" onclick="switchTab('wordcloud')">Word Cloud & Sentiment</button>
        </div>

        <div class="content">
            <div id="postsTab" class="tab-content active">
                <div class="filter-note">
                    Select participation type, author name, homework assignments, and LLM agents above, then click Search to view posts
                </div>

                <h3 style="margin-bottom: 20px; color: #003262;">Posts</h3>
                <div class="posts-grid" id="postsGrid">
                    <p class="placeholder">Select filters above and click Search to see posts</p>
                </div>
            </div>

            <div id="summaryTab" class="tab-content">
                <div class="summary-view">
                    <div class="summary-card">
                        <h3>Ed Post</h3>
                        <div class="summary-text" id="summaryText">
                            <p class="placeholder">Select participation type,  author name, homework assignment, and LLM agent to view the Ed post.</p>
                        </div>
                    </div>
                    <div class="pdf-viewer" id="pdfViewer">
                        <div class="placeholder">
                            <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="#6c757d" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                            </svg>
                            <p>PDF attachment will appear here</p>
                            <p style="font-size: 12px; color: #868e96; margin-top: 5px;">Click on a post from the Posts tab to view</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="wordcloudTab" class="tab-content">
                <div class="filter-note">
                    Select participation type, homework assignment, and LLM agent above, then click Search to generate word cloud and sentiment analysis
                </div>

                <h3 style="margin-bottom: 20px; color: #003262;">Word Cloud</h3>
                <div id="wordcloud"></div>
                
                <h3 style="margin-bottom: 20px; margin-top: 40px; color: #003262;">Sentiment Analysis by LLM Agent</h3>
                <div class="sentiment-grid" id="sentimentGrid">
                    <p class="placeholder">Select filters above and click Search to see analysis</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const API_BASE_URL = 'https://ucb-ed-cs182.onrender.com/api';
        
        // Global data storage
        let studentsData = [];
        let homeworksData = [];
        let llmsData = [];
        let submissionsData = {};
        let sentimentData = {};
        let postsData = [];

        // API Functions
        async function fetchStudents() {
            try {
                const response = await fetch(`${API_BASE_URL}/students`);
                if (!response.ok) throw new Error('Failed to fetch students');
                const data = await response.json();
                studentsData = data;
                populateStudentDropdown(data);
                return data;
            } catch (error) {
                console.error('Error fetching students:', error);
                showError('studentDropdownItems', 'Failed to load students. Please check your API connection.');
                return [];
            }
        }

        async function fetchHomeworks() {
            try {
                const response = await fetch(`${API_BASE_URL}/homeworks`);
                if (!response.ok) throw new Error('Failed to fetch homeworks');
                const data = await response.json();
                homeworksData = data;
                populateHomeworkDropdown(data);
                return data;
            } catch (error) {
                console.error('Error fetching homeworks:', error);
                showError('homeworkDropdownItems', 'Failed to load homeworks. Please check your API connection.');
                return [];
            }
        }

        async function fetchLLMs() {
            try {
                const response = await fetch(`${API_BASE_URL}/llms`);
                if (!response.ok) throw new Error('Failed to fetch LLMs');
                const data = await response.json();
                llmsData = data;
                if (data && data.length > 0) {
                    populateLLMDropdown(data);
                } else {
                    console.warn('API returned empty LLMs array, trying posts data...');
                    // Try to get from posts if API returns empty
                    const posts = await fetch(`${API_BASE_URL}/posts`);
                    if (posts.ok) {
                        const postsData = await posts.json();
                        if (postsData && postsData.length > 0) {
                            await populateDropdownsFromPosts();
                            return;
                        }
                    }
                }
                return data;
            } catch (error) {
                console.error('Error fetching LLMs from API:', error);
                // Don't show error immediately - try to get from posts first
                console.log('Trying to populate LLMs from posts data...');
                try {
                    const posts = await fetch(`${API_BASE_URL}/posts`);
                    if (posts.ok) {
                        const postsData = await posts.json();
                        if (postsData && postsData.length > 0) {
                            await populateDropdownsFromPosts();
                            return [];
                        }
                    }
                } catch (postsError) {
                    console.error('Error fetching posts:', postsError);
                }
                // Only show error if both methods failed
                showError('llmDropdownItems', 'Failed to load LLM agents. Please check your API connection.');
                return [];
            }
        }

        async function fetchSubmission(student, homework, llm) {
            try {
                // Ensure homework is converted to string for the API
                const homeworkStr = String(homework);
                const response = await fetch(`${API_BASE_URL}/submissions?student=${encodeURIComponent(student)}&homework=${encodeURIComponent(homeworkStr)}&llm=${encodeURIComponent(llm)}`);
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Failed to fetch submission:', response.status, errorText);
                    throw new Error(`Failed to fetch submission: ${response.status}`);
                }
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error fetching submission:', error);
                return null;
            }
        }

        async function fetchSentimentAnalysis(students, homeworks, llms) {
            try {
                const params = new URLSearchParams();
                if (students.length > 0) params.append('students', students.join(','));
                if (homeworks.length > 0) params.append('homeworks', homeworks.join(','));
                if (llms.length > 0) params.append('llms', llms.join(','));
                
                const response = await fetch(`${API_BASE_URL}/sentiment?${params.toString()}`);
                if (!response.ok) throw new Error('Failed to fetch sentiment analysis');
                const data = await response.json();
                sentimentData = data;
                return data;
            } catch (error) {
                console.error('Error fetching sentiment analysis:', error);
                return {};
            }
        }

        async function fetchPosts(participation, students, homeworks, llms) {
            try {
                const params = new URLSearchParams();
                if (participation.length > 0) params.append('participation', participation.join(','));
                if (students.length > 0) params.append('students', students.join(','));
                if (homeworks.length > 0) params.append('homeworks', homeworks.join(','));
                if (llms.length > 0) params.append('llms', llms.join(','));
                
                const response = await fetch(`${API_BASE_URL}/posts?${params.toString()}`);
                if (!response.ok) throw new Error('Failed to fetch posts');
                const data = await response.json();
                postsData = data;
                return data;
            } catch (error) {
                console.error('Error fetching posts:', error);
                return [];
            }
        }

        function showError(containerId, message) {
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = `<div class="error-message">${message}</div>`;
            }
        }

        function populateStudentDropdown(students) {
            const container = document.getElementById('studentDropdownItems');
            if (!container) return;
            
            container.innerHTML = '';
            students.forEach((student, index) => {
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                const id = `student_${index}_${student.name.replace(/\s+/g, '_').toLowerCase()}`;
                item.innerHTML = `
                    <input type="checkbox" id="${id}" value="${student.name}" onchange="updateDisplay('student')">
                    <label for="${id}">${student.name}</label>
                `;
                container.appendChild(item);
            });
        }

        function populateHomeworkDropdown(homeworks) {
            const container = document.getElementById('homeworkDropdownItems');
            if (!container) return;
            
            container.innerHTML = '';
            homeworks.forEach((hw) => {
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                item.setAttribute('data-student', hw.students.join(','));
                item.setAttribute('data-llm', hw.llms.join(','));
                let displayText;
                let safeId;
                if (hw.number === 'N/A' || hw.number === 'n/a') {
                    displayText = 'N/A';
                    safeId = 'hw_na';
                } else if (hw.number === 'unknown' || hw.number === 'Unknown') {
                    displayText = 'unknown';
                    safeId = 'hw_unknown';
                } else if (hw.number === 0 || hw.number === '0') {
                    displayText = 'Homework 0';
                    safeId = 'hw_0';
                } else {
                    displayText = `Homework ${hw.number}`;
                    safeId = `hw_${hw.number}`;
                }
                item.innerHTML = `
                    <input type="checkbox" id="${safeId}" value="${hw.number}" onchange="updateDisplay('homework')">
                    <label for="${safeId}">${displayText}</label>
                `;
                container.appendChild(item);
            });
        }

        function populateLLMDropdown(llms) {
            const container = document.getElementById('llmDropdownItems');
            if (!container) {
                console.error('LLM dropdown container not found');
                return;
            }
            
            console.log('populateLLMDropdown called with:', llms);
            console.log('Type of llms:', typeof llms, 'Is array:', Array.isArray(llms));
            
            // Handle empty or invalid input
            if (!llms) {
                console.warn('No LLMs provided (null/undefined)');
                container.innerHTML = '<div class="dropdown-item"><p style="padding: 10px; color: #6c757d;">No LLM agents available</p></div>';
                return;
            }
            
            if (!Array.isArray(llms)) {
                console.warn('LLMs is not an array:', llms);
                container.innerHTML = '<div class="dropdown-item"><p style="padding: 10px; color: #6c757d;">Invalid LLM data format</p></div>';
                return;
            }
            
            if (llms.length === 0) {
                console.warn('Empty LLMs array');
                container.innerHTML = '<div class="dropdown-item"><p style="padding: 10px; color: #6c757d;">No LLM agents available</p></div>';
                return;
            }
            
            // Preserve currently selected values before clearing
            const currentlySelected = getSelectedValues('llm');
            console.log('Preserving selected LLMs:', currentlySelected);
            
            container.innerHTML = '';
            
            let itemsAdded = 0;
            llms.forEach((llm, index) => {
                try {
                    // Handle both object format {name, students, homeworks} and string format
                    let llmName;
                    if (typeof llm === 'string') {
                        llmName = llm;
                    } else if (llm && typeof llm === 'object') {
                        llmName = llm.name || llm.llm || llm.agent || llm;
                    } else {
                        llmName = String(llm);
                    }
                    
                    if (!llmName || (typeof llmName === 'string' && llmName.trim() === '')) {
                        console.warn('Skipping LLM with no name:', llm);
                        return;
                    }
                    
                    llmName = String(llmName).trim();
                    
                    const item = document.createElement('div');
                    item.className = 'dropdown-item';
                    
                    // Handle students and homeworks - support both object and string formats
                    const students = (typeof llm === 'object' && llm.students && Array.isArray(llm.students)) ? llm.students : [];
                    const homeworks = (typeof llm === 'object' && llm.homeworks && Array.isArray(llm.homeworks)) ? llm.homeworks : [];
                    
                    item.setAttribute('data-student', students.join(','));
                    item.setAttribute('data-homework', homeworks.join(','));
                    
                    const safeName = llmName.replace(/\s+/g, '_').replace(/[^a-z0-9_]/gi, '').toLowerCase();
                    const id = `llm_${index}_${safeName}`;
                    const isSelected = currentlySelected.includes(llmName);
                    
                    item.innerHTML = `
                        <input type="checkbox" id="${id}" value="${llmName}" ${isSelected ? 'checked' : ''} onchange="updateDisplay('llm')">
                        <label for="${id}">${llmName}</label>
                    `;
                    container.appendChild(item);
                    itemsAdded++;
                } catch (error) {
                    console.error('Error processing LLM item:', llm, error);
                }
            });
            
            // Update display after repopulating
            updateDisplay('llm');
            const llmNames = llms.map(l => {
                if (typeof l === 'string') return l;
                if (l && typeof l === 'object') return l.name || l.llm || l.agent || String(l);
                return String(l);
            }).filter(Boolean);
            console.log(`Populated LLM dropdown with ${itemsAdded} agents (out of ${llms.length} provided):`, llmNames);
            
            if (itemsAdded === 0) {
                container.innerHTML = '<div class="dropdown-item"><p style="padding: 10px; color: #6c757d;">No valid LLM agents found in data</p></div>';
            }
        }

        // Populate dropdowns from posts data
        async function populateDropdownsFromPosts() {
            try {
                const response = await fetch(`${API_BASE_URL}/posts`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const posts = await response.json();
                
                // Store posts globally for filtering
                postsData = posts;
                
                console.log(`Fetched ${posts.length} posts from API`);
                
                if (!posts || posts.length === 0) {
                    console.warn('No posts found in database. Make sure ed_integration.py is running and has processed some posts.');
                    // Show a message to the user
                    const studentContainer = document.getElementById('studentDropdownItems');
                    if (studentContainer) {
                        studentContainer.innerHTML = `
                            <div class="error-message" style="margin: 10px;">
                                <p>No posts found in database.</p>
                                <p style="font-size: 12px; margin-top: 5px;">
                                    Make sure:<br>
                                    1. ed_integration.py is running<br>
                                    2. It has connected to Ed and received some posts<br>
                                    3. The backend API is running on port 8320
                                </p>
                            </div>
                        `;
                    }
                    // Still try to fetch from other endpoints as fallback
                    await Promise.all([
                        fetchStudents(),
                        fetchHomeworks(),
                        fetchLLMs()
                    ]);
                    return;
                }
                
                // Extract unique values from posts
                const studentsSet = new Set();
                const homeworksSet = new Set();
                const llmsSet = new Set();
                
                posts.forEach(post => {
                    if (post.author && post.author !== 'Unknown') {
                        studentsSet.add(post.author);
                    }
                    // Check for homework_number - need to handle 0, "N/A", "unknown", and other values
                    // Use !== null && !== undefined to properly handle 0 (which is falsy)
                    // Allow 0, numeric values, "N/A", but exclude null, undefined, empty string, and "unknown"
                    if (post.homework_number !== null && 
                        post.homework_number !== undefined && 
                        post.homework_number !== '') {
                        // Convert to string for consistent comparison, including 0
                        const hwStr = String(post.homework_number);
                        // Add all valid homework numbers including 0, but exclude "unknown"
                        if (hwStr !== 'unknown' && hwStr !== 'Unknown') {
                            homeworksSet.add(hwStr);
                        }
                    }
                    // Extract LLM agent - be more inclusive to catch all LLMs
                    const llmAgent = post.llm_agent || post.llm || post.agent;
                    if (llmAgent && 
                        llmAgent !== 'Unknown' && 
                        llmAgent !== 'unknown' && 
                        llmAgent.trim() !== '') {
                        llmsSet.add(llmAgent.trim());
                    }
                });
                
                console.log(`Found ${studentsSet.size} students, ${homeworksSet.size} homeworks, ${llmsSet.size} LLMs`);
                console.log('Homework values in set:', Array.from(homeworksSet));
                console.log('LLM values in set:', Array.from(llmsSet));
                
                // Populate dropdowns
                const students = Array.from(studentsSet).sort();
                // Sort homeworks: numeric values first (including 0), then "unknown", then "N/A" at the end
                const homeworks = Array.from(homeworksSet).sort((a, b) => {
                    // N/A goes to very end
                    if (a === 'N/A' || a === 'n/a') return 1;
                    if (b === 'N/A' || b === 'n/a') return -1;
                    // "unknown" goes before N/A but after numbers
                    if (a === 'unknown' || a === 'Unknown') return 1;
                    if (b === 'unknown' || b === 'Unknown') return -1;
                    // Handle numeric values including 0
                    const numA = parseInt(a);
                    const numB = parseInt(b);
                    if (isNaN(numA) && isNaN(numB)) return a.localeCompare(b);
                    if (isNaN(numA)) return 1;
                    if (isNaN(numB)) return -1;
                    // Both are numbers, sort numerically (0 will be first)
                    return numA - numB;
                });
                console.log('Sorted homeworks:', homeworks);
                const llms = Array.from(llmsSet).sort();
                
                populateStudentDropdown(students.map(name => ({name})));
                populateHomeworkDropdown(homeworks.map(num => ({
                    number: num,
                    students: posts.filter(p => String(p.homework_number) === num && p.author && p.author !== 'Unknown').map(p => p.author).filter(Boolean),
                    llms: posts.filter(p => String(p.homework_number) === num && p.llm_agent && p.llm_agent !== 'Unknown').map(p => p.llm_agent).filter(Boolean)
                })));
                // Extract LLMs more comprehensively - check multiple fields
                const llmsWithData = llms.map(name => {
                    // Find posts with this LLM - check multiple possible field names
                    const matchingPosts = posts.filter(p => {
                        const postLLM = p.llm_agent || p.llm || p.agent;
                        if (!postLLM) return false;
                        const postLLMStr = String(postLLM).trim();
                        const nameStr = String(name).trim();
                        return postLLMStr === nameStr;
                    });
                    return {
                        name: String(name).trim(),
                        students: matchingPosts.filter(p => p.author && p.author !== 'Unknown').map(p => p.author).filter(Boolean),
                        homeworks: matchingPosts.filter(p => p.homework_number !== null && p.homework_number !== undefined).map(p => String(p.homework_number)).filter(Boolean)
                    };
                }).filter(llm => llm.name && llm.name !== ''); // Filter out empty names
                
                console.log(`Populating LLM dropdown with ${llmsWithData.length} agents from posts`);
                console.log('LLMs with data:', llmsWithData);
                if (llmsWithData.length > 0) {
                    populateLLMDropdown(llmsWithData);
                } else {
                    console.warn('No LLMs found in posts data');
                    // Don't call fetchLLMs() here as it will show an error
                    // Instead, just show a message in the dropdown
                    const container = document.getElementById('llmDropdownItems');
                    if (container) {
                        container.innerHTML = '<div class="dropdown-item"><p style="padding: 10px; color: #6c757d;">No LLM agents found in posts. Make sure posts have llm_agent field.</p></div>';
                    }
                }
                
                // Also update global data
                studentsData = students.map(name => ({name}));
                homeworksData = homeworks.map(num => ({
                    number: num,
                    students: posts.filter(p => String(p.homework_number) === num && p.author && p.author !== 'Unknown').map(p => p.author).filter(Boolean),
                    llms: posts.filter(p => String(p.homework_number) === num && p.llm_agent && p.llm_agent !== 'Unknown').map(p => p.llm_agent).filter(Boolean)
                }));
                // Update llmsData with comprehensive matching
                llmsData = llms.map(name => {
                    const matchingPosts = posts.filter(p => {
                        const postLLM = p.llm_agent || p.llm || p.agent;
                        if (!postLLM) return false;
                        const postLLMStr = String(postLLM).trim();
                        const nameStr = String(name).trim();
                        return postLLMStr === nameStr;
                    });
                    return {
                        name: String(name).trim(),
                        students: matchingPosts.filter(p => p.author && p.author !== 'Unknown').map(p => p.author).filter(Boolean),
                        homeworks: matchingPosts.filter(p => p.homework_number !== null && p.homework_number !== undefined).map(p => String(p.homework_number)).filter(Boolean)
                    };
                }).filter(llm => llm.name && llm.name !== '');
                
                filterDropdowns();
            } catch (error) {
                console.error('Error populating from posts:', error);
                // Show error message
                const studentContainer = document.getElementById('studentDropdownItems');
                if (studentContainer) {
                    studentContainer.innerHTML = `
                        <div class="error-message" style="margin: 10px;">
                            <p>Error connecting to API: ${error.message}</p>
                            <p style="font-size: 12px; margin-top: 5px;">
                                Check that the backend API is running at ${API_BASE_URL}
                            </p>
                        </div>
                    `;
                }
                // Fallback to API endpoints (but don't show errors for LLMs if posts failed)
                try {
                    await Promise.all([
                        fetchStudents(),
                        fetchHomeworks()
                        // Don't call fetchLLMs() here as it will show an error
                        // The LLM dropdown will be populated from posts when they're available
                    ]);
                } catch (fallbackError) {
                    console.error('Fallback also failed:', fallbackError);
                }
                filterDropdowns();
            }
        }

        // Check API health
        async function checkAPIHealth() {
            try {
                const response = await fetch(`${API_BASE_URL.replace('/api', '')}/`);
                if (!response.ok) throw new Error('API not responding');
                const data = await response.json();
                console.log('API Health:', data);
                if (data.stats && data.stats.posts === 0) {
                    console.warn('  No posts in database. Make sure ed_integration.py is running and has received posts.');
                }
                return data;
            } catch (error) {
                console.error(' API Health Check Failed:', error);
                return null;
            }
        }

        // Initialize data on page load
        async function initializeData() {
            // Check API health first
            const health = await checkAPIHealth();
            if (!health) {
                const studentContainer = document.getElementById('studentDropdownItems');
                if (studentContainer) {
                    studentContainer.innerHTML = `
                        <div class="error-message" style="margin: 10px;">
                            <p><strong>Cannot connect to API</strong></p>
                            <p style="font-size: 12px; margin-top: 5px;">
                                Make sure the backend API is running:<br>
                                <code>python backend_api.py</code><br><br>
                                Expected URL: ${API_BASE_URL.replace('/api', '')}
                            </p>
                        </div>
                    `;
                }
                return;
            }
            
            // Try to populate from posts first, fallback to API endpoints
            await populateDropdownsFromPosts();
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initializeData);
        
        // Refresh data every 30 seconds to get new posts
        setInterval(async () => {
            console.log('Refreshing data from posts...');
            await populateDropdownsFromPosts();
        }, 30000);

        function toggleDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            const allDropdowns = document.querySelectorAll('.dropdown-menu');
            
            allDropdowns.forEach(d => {
                if (d.id !== dropdownId) {
                    d.classList.remove('show');
                    // Clear search in other dropdowns
                    const searchInput = d.querySelector('.search-input');
                    if (searchInput) {
                        searchInput.value = '';
                        const type = d.id.includes('student') ? 'student' : d.id.includes('homework') ? 'homework' : d.id.includes('participation') ? 'participation' : 'llm';
                        filterDropdown(type, '');
                    }
                }
            });
            
            const isOpening = !dropdown.classList.contains('show');
            dropdown.classList.toggle('show');
            
            // Focus search input when opening
            if (isOpening) {
                const searchInput = dropdown.querySelector('.search-input');
                if (searchInput) {
                    setTimeout(() => searchInput.focus(), 100);
                }
            }
        }

        document.addEventListener('click', function(e) {
            if (!e.target.closest('.dropdown-container') && !e.target.closest('.control-btn') && !e.target.closest('.search-input')) {
                document.querySelectorAll('.dropdown-menu').forEach(d => {
                    d.classList.remove('show');
                });
            }
        });

        function filterDropdown(type, searchTerm) {
            let dropdownId, items;
            if (type === 'student') {
                dropdownId = 'studentDropdown';
            } else if (type === 'homework') {
                dropdownId = 'homeworkDropdown';
            } else if (type === 'llm') {
                dropdownId = 'llmDropdown';
            } else if (type === 'participation') {
                dropdownId = 'participationDropdown';
            }
            
            items = document.querySelectorAll(`#${dropdownId} .dropdown-item`);
            const searchLower = searchTerm.toLowerCase().trim();
            
            items.forEach(item => {
                if (item.classList.contains('disabled')) {
                    return; // Don't filter disabled items, they're already hidden
                }
                
                let text = '';
                // Get text from label for all dropdown types
                const label = item.querySelector('label');
                if (label) {
                    text = label.textContent.toLowerCase();
                } else {
                    // Fallback: try to get text from the item itself
                    text = item.textContent.toLowerCase();
                }
                
                if (searchLower === '' || text.includes(searchLower)) {
                    item.classList.remove('hidden');
                } else {
                    item.classList.add('hidden');
                }
            });
        }

        function selectAll(type) {
            let checkboxes;
            if (type === 'student') {
                checkboxes = document.querySelectorAll('#studentDropdown .dropdown-item:not(.disabled):not(.hidden) input[type="checkbox"]');
            } else if (type === 'homework') {
                checkboxes = document.querySelectorAll('#homeworkDropdown .dropdown-item:not(.disabled):not(.hidden) input[type="checkbox"]');
            } else if (type === 'llm') {
                checkboxes = document.querySelectorAll('#llmDropdown .dropdown-item:not(.disabled):not(.hidden) input[type="checkbox"]');
            } else if (type === 'participation') {
                checkboxes = document.querySelectorAll('#participationDropdown .dropdown-item:not(.disabled):not(.hidden) input[type="checkbox"]');
            }
            checkboxes.forEach(cb => cb.checked = true);
            updateDisplay(type);
            filterDropdowns();
        }

        function unselectAll(type) {
            let checkboxes;
            if (type === 'student') {
                checkboxes = document.querySelectorAll('#studentDropdown input[type="checkbox"]');
            } else if (type === 'homework') {
                checkboxes = document.querySelectorAll('#homeworkDropdown input[type="checkbox"]');
            } else if (type === 'llm') {
                checkboxes = document.querySelectorAll('#llmDropdown input[type="checkbox"]');
            } else if (type === 'participation') {
                checkboxes = document.querySelectorAll('#participationDropdown input[type="checkbox"]');
            }
            checkboxes.forEach(cb => cb.checked = false);
            updateDisplay(type);
            filterDropdowns();
        }

        function clearAllSelections() {
            // Simply refresh the page to reset all state
            window.location.reload();
        }

        function updateDisplay(type) {
            let checkboxes, display;
            
            if (type === 'student') {
                checkboxes = document.querySelectorAll('#studentDropdown input[type="checkbox"]');
                display = document.getElementById('studentDisplay');
            } else if (type === 'homework') {
                checkboxes = document.querySelectorAll('#homeworkDropdown input[type="checkbox"]');
                display = document.getElementById('homeworkDisplay');
            } else if (type === 'llm') {
                checkboxes = document.querySelectorAll('#llmDropdown input[type="checkbox"]');
                display = document.getElementById('llmDisplay');
            } else if (type === 'participation') {
                checkboxes = document.querySelectorAll('#participationDropdown input[type="checkbox"]');
                display = document.getElementById('participationDisplay');
            }
            
            const selected = Array.from(checkboxes).filter(cb => cb.checked);
            const count = selected.length;
            
            if (!display) {
                console.warn(`Display element not found for type: ${type}`);
                return;
            }
            
            if (count === 0) {
                const placeholderText = type === 'student' ? 'Select students...' : 
                                      type === 'homework' ? 'Select homework...' : 
                                      type === 'llm' ? 'Select LLM agents...' : 
                                      'Select participation...';
                display.innerHTML = `<span class="dropdown-placeholder">${placeholderText}</span>`;
            } else if (count === 1) {
                // Get the label text - try multiple methods
                const checkbox = selected[0];
                let labelText = '';
                // Try nextElementSibling (label after checkbox)
                if (checkbox.nextElementSibling && checkbox.nextElementSibling.tagName === 'LABEL') {
                    labelText = checkbox.nextElementSibling.textContent;
                } else {
                    // Try parent's label
                    const parent = checkbox.closest('.dropdown-item');
                    if (parent) {
                        const label = parent.querySelector('label');
                        if (label) {
                            labelText = label.textContent;
                        } else {
                            // Fallback to checkbox value
                            labelText = checkbox.value;
                        }
                    } else {
                        labelText = checkbox.value;
                    }
                }
                display.innerHTML = `${labelText}<span class="selected-count">${count}</span>`;
            } else {
                display.innerHTML = `${count} selected<span class="selected-count">${count}</span>`;
            }

            filterDropdowns();
        }

        function filterDropdowns() {
            const selectedStudents = getSelectedValues('student');
            const selectedHomework = getSelectedValues('homework');
            const selectedLLMs = getSelectedValues('llm');
            const selectedParticipation = getSelectedValues('participation');

            // Use posts data for filtering - this is the source of truth
            // If no posts data, fetch it first (but don't block)
            const allPosts = postsData.length > 0 ? postsData : [];
            
            // If we have no posts data but need to filter, try to fetch it
            if (allPosts.length === 0 && (selectedStudents.length > 0 || selectedHomework.length > 0 || selectedLLMs.length > 0 || selectedParticipation.length > 0)) {
                // Don't block, just proceed with empty data (will show all options)
                console.log('No posts data available for filtering, showing all options');
            }
            
            // Helper function to check if a post matches current filters
            function postMatchesFilters(post, student = null, homework = null, llm = null, participation = null) {
                const matchesStudent = !student || (post.author && post.author === student);
                // Handle homework matching - treat 0 the same as other numbers
                let matchesHw = true;
                if (homework !== null && homework !== undefined && homework !== '') {
                    const postHw = post.homework_number;
                    // Convert both to strings for comparison, handling 0 properly
                    const postHwStr = postHw !== null && postHw !== undefined ? String(postHw) : '';
                    const homeworkStr = String(homework);
                    matchesHw = postHwStr === homeworkStr;
                }
                // Handle LLM matching - check if llm_agent matches (case-insensitive)
                const matchesLLM = !llm || (post.llm_agent && post.llm_agent.toLowerCase() === llm.toLowerCase());
                const participationType = post.participation_type || post.participation || '';
                const matchesParticipation = !participation || participationType.toUpperCase() === participation.toUpperCase();
                return matchesStudent && matchesHw && matchesLLM && matchesParticipation;
            }
            
            // Helper function to check if there are any posts matching the current selection
            function hasMatchingPosts(student = null, homework = null, llm = null, participation = null) {
                if (allPosts.length === 0) return true; // If no posts data, show all
                return allPosts.some(post => postMatchesFilters(post, student, homework, llm, participation));
            }
            
            // Filter Homework dropdown
            document.querySelectorAll('#homeworkDropdown .dropdown-item').forEach(item => {
                const inputEl = item.querySelector('input');
                if (!inputEl) return; // Skip items without input (like loading spinners)
                
                const hwValue = inputEl.value;
                let show = true;
                
                // Check if any posts match this homework with selected students/LLMs/participation
                if (selectedStudents.length > 0 || selectedLLMs.length > 0 || selectedParticipation.length > 0) {
                    show = false;
                    // Check if any selected student + this homework + any selected LLM + any selected participation has a matching post
                    for (const student of selectedStudents.length > 0 ? selectedStudents : [null]) {
                        for (const llm of selectedLLMs.length > 0 ? selectedLLMs : [null]) {
                            for (const participation of selectedParticipation.length > 0 ? selectedParticipation : [null]) {
                                if (hasMatchingPosts(student, hwValue, llm, participation)) {
                                    show = true;
                                    break;
                                }
                            }
                            if (show) break;
                        }
                        if (show) break;
                    }
                }

                const isCurrentlySelected = inputEl.checked;
                
                if (!show && (selectedStudents.length > 0 || selectedLLMs.length > 0 || selectedParticipation.length > 0)) {
                    // Only disable if not currently selected (preserve user's current selection)
                    if (!isCurrentlySelected) {
                        item.classList.add('disabled');
                        inputEl.disabled = true;
                    } else {
                        // Keep it enabled if it's selected
                        item.classList.remove('disabled');
                        inputEl.disabled = false;
                    }
                } else {
                    item.classList.remove('disabled');
                    inputEl.disabled = false;
                }
            });

            // Filter Student dropdown
            document.querySelectorAll('#studentDropdown .dropdown-item').forEach(item => {
                const inputEl = item.querySelector('input');
                if (!inputEl) return; // Skip items without input (like loading spinners)
                
                const student = inputEl.value;
                let show = true;
                
                // Check if any posts match this student with selected homeworks/LLMs/participation
                if (selectedHomework.length > 0 || selectedLLMs.length > 0 || selectedParticipation.length > 0) {
                    show = false;
                    // Check if this student + any selected homework + any selected LLM + any selected participation has a matching post
                    for (const hw of selectedHomework.length > 0 ? selectedHomework : [null]) {
                        for (const llm of selectedLLMs.length > 0 ? selectedLLMs : [null]) {
                            for (const participation of selectedParticipation.length > 0 ? selectedParticipation : [null]) {
                                if (hasMatchingPosts(student, hw, llm, participation)) {
                                    show = true;
                                    break;
                                }
                            }
                            if (show) break;
                        }
                        if (show) break;
                    }
                }

                if (!show && (selectedHomework.length > 0 || selectedLLMs.length > 0 || selectedParticipation.length > 0)) {
                    item.classList.add('disabled');
                    inputEl.disabled = true;
                } else {
                    item.classList.remove('disabled');
                    inputEl.disabled = false;
                }
            });

            // Filter LLM dropdown
            document.querySelectorAll('#llmDropdown .dropdown-item').forEach(item => {
                const inputEl = item.querySelector('input');
                if (!inputEl) return; // Skip items without input (like loading spinners)
                
                const llm = inputEl.value;
                let show = true;
                
                // Check if any posts match this LLM with selected students/homeworks/participation
                if (selectedStudents.length > 0 || selectedHomework.length > 0 || selectedParticipation.length > 0) {
                    show = false;
                    // Check if any selected student + any selected homework + this LLM + any selected participation has a matching post
                    // We need to check all combinations to see if this LLM is valid
                    for (const student of selectedStudents.length > 0 ? selectedStudents : [null]) {
                        for (const hw of selectedHomework.length > 0 ? selectedHomework : [null]) {
                            for (const participation of selectedParticipation.length > 0 ? selectedParticipation : [null]) {
                                if (hasMatchingPosts(student, hw, llm, participation)) {
                                    show = true;
                                    break;
                                }
                            }
                            if (show) break;
                        }
                        if (show) break;
                    }
                }

                // Disable if no matching posts found and there are active filters
                // BUT don't disable if this item is already selected (to prevent losing selections)
                const isCurrentlySelected = inputEl.checked;
                
                if (!show && (selectedStudents.length > 0 || selectedHomework.length > 0 || selectedParticipation.length > 0)) {
                    // Only disable if not currently selected (preserve user's current selection)
                    if (!isCurrentlySelected) {
                        item.classList.add('disabled');
                        inputEl.disabled = true;
                    } else {
                        // Keep it enabled if it's selected, even if no matches (user might be building their selection)
                        item.classList.remove('disabled');
                        inputEl.disabled = false;
                    }
                } else {
                    item.classList.remove('disabled');
                    inputEl.disabled = false;
                }
            });

            // Filter Participation dropdown
            document.querySelectorAll('#participationDropdown .dropdown-item').forEach(item => {
                const inputEl = item.querySelector('input');
                if (!inputEl) return; // Skip items without input (like loading spinners)
                
                const participation = inputEl.value;
                let show = true;
                
                // Check if any posts match this participation with selected students/homeworks/LLMs
                if (selectedStudents.length > 0 || selectedHomework.length > 0 || selectedLLMs.length > 0) {
                    show = false;
                    // Check if any selected student + any selected homework + any selected LLM + this participation has a matching post
                    for (const student of selectedStudents.length > 0 ? selectedStudents : [null]) {
                        for (const hw of selectedHomework.length > 0 ? selectedHomework : [null]) {
                            for (const llm of selectedLLMs.length > 0 ? selectedLLMs : [null]) {
                                if (hasMatchingPosts(student, hw, llm, participation)) {
                                    show = true;
                                    break;
                                }
                            }
                            if (show) break;
                        }
                        if (show) break;
                    }
                }

                const isCurrentlySelected = inputEl.checked;
                
                if (!show && (selectedStudents.length > 0 || selectedHomework.length > 0 || selectedLLMs.length > 0)) {
                    // Only disable if not currently selected (preserve user's current selection)
                    if (!isCurrentlySelected) {
                        item.classList.add('disabled');
                        inputEl.disabled = true;
                    } else {
                        // Keep it enabled if it's selected
                        item.classList.remove('disabled');
                        inputEl.disabled = false;
                    }
                } else {
                    item.classList.remove('disabled');
                    inputEl.disabled = false;
                }
            });
        }

        function getSelectedValues(type) {
            let checkboxes;
            if (type === 'student') {
                checkboxes = document.querySelectorAll('#studentDropdown input[type="checkbox"]');
            } else if (type === 'homework') {
                checkboxes = document.querySelectorAll('#homeworkDropdown input[type="checkbox"]');
            } else if (type === 'llm') {
                checkboxes = document.querySelectorAll('#llmDropdown input[type="checkbox"]');
            } else if (type === 'participation') {
                checkboxes = document.querySelectorAll('#participationDropdown input[type="checkbox"]');
            }
            // Filter out disabled checkboxes and only return checked, enabled ones
            return Array.from(checkboxes)
                .filter(cb => cb.checked && !cb.disabled)
                .map(cb => cb.value);
        }

        function setSelectedValue(type, value) {
            let checkboxes;
            if (type === 'student') {
                checkboxes = document.querySelectorAll('#studentDropdown input[type="checkbox"]');
            } else if (type === 'homework') {
                checkboxes = document.querySelectorAll('#homeworkDropdown input[type="checkbox"]');
            } else if (type === 'llm') {
                checkboxes = document.querySelectorAll('#llmDropdown input[type="checkbox"]');
            } else if (type === 'participation') {
                checkboxes = document.querySelectorAll('#participationDropdown input[type="checkbox"]');
            }
            
            // Uncheck all first
            checkboxes.forEach(cb => cb.checked = false);
            
            // Check the matching checkbox - try multiple comparison methods
            let found = false;
            checkboxes.forEach(cb => {
                // Try exact match
                if (cb.value === value) {
                    cb.checked = true;
                    found = true;
                }
                // Try string comparison
                else if (String(cb.value) === String(value)) {
                    cb.checked = true;
                    found = true;
                }
                // Try number comparison (for homework numbers)
                else if (type === 'homework' && !isNaN(cb.value) && !isNaN(value)) {
                    if (Number(cb.value) === Number(value)) {
                        cb.checked = true;
                        found = true;
                    }
                }
            });
            
            // Always update display immediately
            updateDisplay(type);
            
            return found;
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
            
            // Activate the clicked tab button
            const tabs = document.querySelectorAll('.tab');
            const studentFormGroup = document.getElementById('studentFormGroup');
            
            if (tabName === 'posts') {
                tabs[0].classList.add('active');
                document.getElementById('postsTab').classList.add('active');
                // Show student dropdown on posts tab
                if (studentFormGroup) studentFormGroup.style.display = 'block';
            } else if (tabName === 'summary') {
                tabs[1].classList.add('active');
                document.getElementById('summaryTab').classList.add('active');
                // Show student dropdown on summary tab
                if (studentFormGroup) studentFormGroup.style.display = 'block';
            } else if (tabName === 'wordcloud') {
                tabs[2].classList.add('active');
                document.getElementById('wordcloudTab').classList.add('active');
                // Hide student dropdown on wordcloud/sentiment tab
                if (studentFormGroup) studentFormGroup.style.display = 'none';
            }
            
            // Ensure dropdown displays are updated after tab switch
            // This prevents dropdowns from appearing empty after navigation
            setTimeout(() => {
                updateDisplay('student');
                updateDisplay('homework');
                updateDisplay('llm');
                updateDisplay('participation');
            }, 50);
        }

        async function navigateToPostSummary(post) {
            try {
                console.log('navigateToPostSummary - Full post object:', JSON.stringify(post, null, 2));
                console.log('Post content field:', post.content);
                console.log('Post content type:', typeof post.content);
                
                // Ensure posts data is available for filtering
                if (postsData.length === 0) {
                    console.log('Loading posts data for filtering...');
                    // Fetch all posts without filters to populate dropdowns
                    const allPosts = await fetchPosts([], [], [], []);
                    postsData = allPosts;
                }
                
                // Extract post data
                const author = post.author;
                const homework = post.homework_number;
                const llm = post.llm_agent;
                const participation = post.participation_type || post.participation;
                
                // Try to set dropdown selections if data is available, but don't require them
                // We can still display the post content even if some fields are missing
                if (author) {
                    let studentFound = setSelectedValue('student', author);
                    if (!studentFound) {
                        // Try case-insensitive matching
                        const studentCheckboxes = document.querySelectorAll('#studentDropdown input[type="checkbox"]');
                        studentCheckboxes.forEach(cb => {
                            if (cb.value && cb.value.toLowerCase() === author.toLowerCase()) {
                                cb.checked = true;
                                studentFound = true;
                            }
                        });
                        if (studentFound) {
                            updateDisplay('student');
                        }
                    } else {
                        // Ensure display is updated even if found immediately
                        updateDisplay('student');
                    }
                }
                
                if (homework !== null && homework !== undefined && homework !== '' && homework !== 'unknown' && homework !== 'N/A' && homework !== 'NA') {
                    // Handle homework value - normalize it
                    let homeworkValue = homework;
                    
                    // Normalize homework value - keep as number if numeric, otherwise as string
                    if (homework === 0 || homework === '0') {
                        homeworkValue = 0; // Keep as number 0
                    } else if (!isNaN(homework) && homework !== '') {
                        homeworkValue = Number(homework); // Convert to number
                    } else {
                        homeworkValue = String(homework); // Keep as string
                    }
                    
                    let homeworkFound = setSelectedValue('homework', homeworkValue);
                    
                    // If homework not found, try alternative formats
                    if (!homeworkFound) {
                        // Try as string if it was a number
                        if (typeof homeworkValue === 'number') {
                            homeworkFound = setSelectedValue('homework', String(homeworkValue));
                        } else {
                            // Try as number if it was a string
                            const numValue = Number(homeworkValue);
                            if (!isNaN(numValue)) {
                                homeworkFound = setSelectedValue('homework', numValue);
                            }
                        }
                    }
                    // Ensure display is updated
                    updateDisplay('homework');
                }
                
                if (llm) {
                    let llmFound = setSelectedValue('llm', llm);
                    if (!llmFound) {
                        // Try case-insensitive matching
                        const llmCheckboxes = document.querySelectorAll('#llmDropdown input[type="checkbox"]');
                        llmCheckboxes.forEach(cb => {
                            if (cb.value && cb.value.toLowerCase() === llm.toLowerCase()) {
                                cb.checked = true;
                                llmFound = true;
                            }
                        });
                        if (llmFound) {
                            updateDisplay('llm');
                        }
                    } else {
                        // Ensure display is updated even if found immediately
                        updateDisplay('llm');
                    }
                }
                
                if (participation) {
                    let participationFound = setSelectedValue('participation', participation);
                    if (!participationFound) {
                        // Try case-insensitive matching
                        const participationCheckboxes = document.querySelectorAll('#participationDropdown input[type="checkbox"]');
                        participationCheckboxes.forEach(cb => {
                            if (cb.value && cb.value.toUpperCase() === participation.toUpperCase()) {
                                cb.checked = true;
                                participationFound = true;
                            }
                        });
                        if (participationFound) {
                            updateDisplay('participation');
                        }
                    } else {
                        updateDisplay('participation');
                    }
                }
                
                // Re-filter dropdowns
                filterDropdowns();
                
                // Force update all dropdown displays before switching tabs
                updateDisplay('student');
                updateDisplay('homework');
                updateDisplay('llm');
                updateDisplay('participation');
                
                // Switch to Post Previewer tab
                switchTab('summary');
                
                // Wait a bit to ensure tab switch is complete
                await new Promise(resolve => setTimeout(resolve, 150));
                
                // Force update displays again after tab switch (in case they were cleared)
                updateDisplay('student');
                updateDisplay('homework');
                updateDisplay('llm');
                updateDisplay('participation');
                
                // Re-filter dropdowns
                filterDropdowns();
                
                // Try to call searchSubmission to fetch and display the full post content from API
                console.log('Attempting searchSubmission with filters:', { author, homework, llm, participation });
                
                // Call searchSubmission with skipAlert=true so it won't show an alert if filters are missing
                const searchResult = await searchSubmission(true);
                
                // If searchSubmission returns false (missing filters) or fails, display the post directly
                if (searchResult === false) {
                    console.log('searchSubmission returned false, displaying post content directly');
                    displayPostSummary(post);
                }
            } catch (error) {
                console.error('Error navigating to post summary:', error);
                // Fallback: try to display the post content directly
                try {
                    displayPostSummary(post);
                } catch (e) {
                    console.error('Fallback display also failed:', e);
                    alert('An error occurred while loading the post. Please try selecting the filters manually.');
                }
            }
        }

        function extractPdfsFromContent(content) {
            // Try to extract PDF URLs from HTML content
            if (!content) return [];
            
            const pdfUrls = [];
            const patterns = [
                // Google Drive file URLs
                /href=["']?(https?:\/\/drive\.google\.com\/file\/d\/[^"'\s>]+)["']?/gi,
                // Google Drive direct URLs in content
                /(https?:\/\/drive\.google\.com\/file\/d\/[^\s"'<>]+)/gi,
                // Ed static file URLs (most common for Ed attachments)
                /href=["']?(https?:\/\/static\.us\.edusercontent\.com\/files\/[^"'\s>]+)["']?/gi,
                // Standard PDF links
                /href=["']([^"']*\.pdf[^"']*)['"]/gi,
                // Ed API file URLs
                /href=["']([^"']*edstem\.org\/api\/files[^"']*)['"]/gi,
                // Ed static.edstem.org URLs
                /href=["']([^"']*static\.us\.edstem\.org[^"']*)['"]/gi,
                // Any edusercontent.com file URLs
                /href=["']([^"']*edusercontent\.com\/files[^"']*)['"]/gi,
                // Any file download links
                /<a[^>]*href=["']([^"']+)["'][^>]*download[^>]*>/gi,
                // Direct URLs ending in .pdf
                /(https?:\/\/[^\s"'<>]+\.pdf)/gi,
                // src attributes for embedded files
                /src=["']?(https?:\/\/static\.us\.edusercontent\.com\/files\/[^"'\s>]+)["']?/gi,
            ];
            
            for (const pattern of patterns) {
                // Reset lastIndex to avoid issues with global regex
                pattern.lastIndex = 0;
                let match;
                while ((match = pattern.exec(content)) !== null) {
                    const url = match[1];
                    if (url && !pdfUrls.includes(url)) {
                        // Clean up the URL (remove trailing quotes or spaces)
                        const cleanUrl = url.replace(/["'\s>]+$/, '').trim();
                        if (cleanUrl && !pdfUrls.includes(cleanUrl)) {
                            pdfUrls.push(cleanUrl);
                            console.log('Found file URL:', cleanUrl);
                        }
                    }
                }
            }
            
            console.log('Extracted PDFs from content:', pdfUrls);
            return pdfUrls;
        }

        function displayPostSummary(post) {
            console.log('displayPostSummary called with post:', post);
            console.log('Post content field:', post.content);
            console.log('Post content type:', typeof post.content);
            console.log('Post content length:', post.content ? post.content.length : 0);
            console.log('Post pdf_urls from API:', post.pdf_urls);
            
            // Get the post content - prioritize content field (which comes from thread.content)
            let postContent = post.content;
            
            console.log('Initial postContent:', postContent ? postContent.substring(0, 100) : 'null/undefined');
            
            // If content is not available, try other fields (prioritize full content, not excerpt)
            if (!postContent || (typeof postContent === 'string' && postContent.trim() === '')) {
                console.log('Content not found, trying alternatives...');
                // Try text and body first (full content), only use excerpt as last resort
                postContent = post.text || post.body || '';
                // If still empty, use excerpt but note it's truncated
                if (!postContent || postContent.trim() === '') {
                    postContent = post.excerpt || '';
                    if (postContent) {
                        console.log('Using excerpt (may be truncated)');
                    }
                }
                console.log('Alternative content found:', postContent ? postContent.substring(0, 100) : 'none');
            }
            
            // If still no content, show a message
            if (!postContent || (typeof postContent === 'string' && postContent.trim() === '')) {
                console.warn('No content available for post');
                postContent = 'No content available for this post.';
            }
            
            console.log('Final postContent to display:', postContent ? postContent.substring(0, 200) : 'empty');
            
            // Format the content - preserve line breaks and handle HTML
            // If content contains HTML, we'll display it as-is (it's already HTML from Ed)
            // Otherwise, convert newlines to <br> tags
            let formattedContent = postContent;
            
            // Check if content is already HTML (contains HTML tags)
            const isHTML = /<[a-z][\s\S]*>/i.test(postContent);
            console.log('Content is HTML:', isHTML);
            
            if (!isHTML) {
                // Not HTML, so convert newlines to <br> tags
                formattedContent = postContent.replace(/\n/g, '<br>');
            }
            // If it's already HTML, use it as-is
            
            // Build post header with metadata
            const participationType = post.participation_type || post.participation || '';
            const participationBadge = participationType ? `<span class="participation-badge ${participationType.toLowerCase()}" style="margin-left: 10px;">Participation ${participationType}</span>` : '';
            const hwDisplay = post.homework_number !== null && post.homework_number !== undefined && post.homework_number !== '' && post.homework_number !== 'unknown' ? `HW ${post.homework_number}` : '';
            const llmDisplay = post.llm_agent || '';
            const metaItems = [hwDisplay, llmDisplay].filter(Boolean).join('  ');
            
            // Display in summary text area with header
            const summaryTextEl = document.getElementById('summaryText');
            if (summaryTextEl) {
                // Use different styling for HTML content vs plain text
                const contentStyle = isHTML 
                    ? 'line-height: 1.8; font-size: 16px; color: #212529; padding: 10px 0;'
                    : 'white-space: pre-wrap; line-height: 1.8; font-size: 16px; color: #212529; padding: 10px 0;';
                
                summaryTextEl.innerHTML = `
                    <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 2px solid #dee2e6;">
                        <h4 style="color: #003262; margin-bottom: 8px; font-size: 18px;">${post.title || 'Untitled Post'}</h4>
                        <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                            <span style="font-weight: 600; color: #212529;">${post.author || 'Unknown'}</span>
                            ${participationBadge}
                            ${metaItems ? `<span style="color: #6c757d; font-size: 14px;">${metaItems}</span>` : ''}
                        </div>
                        ${post.url ? `<a href="${post.url}" target="_blank" style="color: #003262; font-size: 14px; margin-top: 8px; display: inline-block; text-decoration: none;">View on Ed </a>` : ''}
                    </div>
                    <div class="ed-post-content" style="${contentStyle}">${formattedContent}</div>
                `;
                console.log('Content displayed in summaryText element, isHTML:', isHTML, 'content length:', formattedContent.length);
            } else {
                console.error('summaryText element not found!');
            }
            
            // Handle PDF display
            // First try to get PDFs from API response
            let pdfUrls = post.pdf_urls || [];
            
            // If no PDFs from API, try to extract from content HTML
            if (pdfUrls.length === 0 && postContent) {
                const extractedPdfs = extractPdfsFromContent(postContent);
                if (extractedPdfs.length > 0) {
                    pdfUrls = extractedPdfs;
                    console.log('Using PDFs extracted from content:', pdfUrls);
                }
            }
            
            console.log('PDF URLs to display:', pdfUrls);
            const pdfViewerEl = document.getElementById('pdfViewer');
            if (pdfViewerEl) {
                if (pdfUrls.length > 0) {
                    let pdfHtml = '';
                    
                    // Add PDF header with count
                    pdfHtml += `<div style="margin-bottom: 15px; text-align: center;">
                        <h4 style="color: #003262; margin-bottom: 10px;"> PDF Attachment${pdfUrls.length > 1 ? 's' : ''} (${pdfUrls.length})</h4>
                    </div>`;
                    
                    // If multiple PDFs, show tabs/buttons to switch between them
                    if (pdfUrls.length > 1) {
                        pdfHtml += '<div style="margin-bottom: 15px; display: flex; gap: 8px; flex-wrap: wrap; justify-content: center;">';
                        pdfUrls.forEach((url, index) => {
                            pdfHtml += `<button onclick="switchPdfView('${url.replace(/'/g, "\\'")}')" 
                                style="color: #003262; font-weight: 600; text-decoration: none; padding: 8px 15px; background: ${index === 0 ? '#FDB515' : '#f8f9fa'}; border: 1px solid #dee2e6; border-radius: 4px; cursor: pointer; transition: all 0.2s;"
                                class="pdf-tab-btn ${index === 0 ? 'active' : ''}"
                                onmouseover="if(!this.classList.contains('active')) this.style.background='#e9ecef'"
                                onmouseout="if(!this.classList.contains('active')) this.style.background='#f8f9fa'">
                                PDF ${index + 1}
                            </button>`;
                        });
                        pdfHtml += '</div>';
                    }
                    
                    // Add download link
                    pdfHtml += `<div style="margin-bottom: 10px; text-align: center;">
                        <a href="${pdfUrls[0]}" target="_blank" download style="color: #003262; font-size: 14px; text-decoration: none;">
                             Open in new tab / Download
                        </a>
                    </div>`;
                    
                    // PDF iframe container - use getEmbedUrl for Google Drive etc.
                    pdfHtml += `<div id="pdfIframeContainer" style="width: 100%; height: 550px; border: 1px solid #dee2e6; border-radius: 8px; overflow: hidden;">
                        <iframe id="pdfIframe" src="${getEmbedUrl(pdfUrls[0])}" width="100%" height="100%" style="border: none;" allow="autoplay"></iframe>
                    </div>`;
                    
                    pdfViewerEl.innerHTML = pdfHtml;
                    pdfViewerEl.style.display = 'block';
                    pdfViewerEl.style.padding = '20px';
                    pdfViewerEl.style.background = '#f8f9fa';
                    pdfViewerEl.style.borderRadius = '8px';
                    pdfViewerEl.style.border = '2px solid #dee2e6';
                } else {
                    pdfViewerEl.innerHTML = `
                        <div style="text-align: center; padding: 40px 20px;">
                            <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="#6c757d" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                            </svg>
                            <p style="color: #003262; font-weight: 600; margin-top: 15px; font-size: 16px;">No PDF Attachment</p>
                            <p style="color: #6c757d; font-size: 14px; margin-top: 5px;">This post does not have a PDF attached.</p>
                        </div>
                    `;
                }
            }
        }

        function handleSearch() {
            const activeTab = document.querySelector('.tab.active').textContent.trim();
            
            if (activeTab.includes('Post Previewer')) {
                searchSubmission();
            } else if (activeTab.includes('Posts')) {
                applyFilters();
            } else if (activeTab.includes('Word Cloud')) {
                applyFilters();
            }
        }

        async function searchSubmission(skipAlert = false) {
            const students = getSelectedValues('student');
            const homeworks = getSelectedValues('homework');
            const llms = getSelectedValues('llm');
            const participation = getSelectedValues('participation');

            // For search, we need at least student, homework, and llm
            if (students.length === 0 || homeworks.length === 0 || llms.length === 0) {
                if (!skipAlert) {
                    alert('Please select at least one option from Author Name, Homework Number, and LLM Agent dropdowns');
                }
                return false;
            }

            const student = students[0];
            const homework = homeworks[0];
            const llm = llms[0];
            const part = participation.length > 0 ? participation[0] : null;

            // Show loading state
            const summaryTextEl = document.getElementById('summaryText');
            const pdfViewerEl = document.getElementById('pdfViewer');
            if (summaryTextEl) {
                summaryTextEl.innerHTML = '<p class="placeholder">Loading submission data...</p>';
            }
            if (pdfViewerEl) {
                pdfViewerEl.innerHTML = '<div class="loading"><div class="loading-spinner"></div><p style="margin-top: 10px;">Loading PDF...</p></div>';
            }

            console.log('Fetching submission:', { student, homework, llm });
            const data = await fetchSubmission(student, homework, llm);
            console.log('Received submission data:', data);

            if (data && (data.content || data.full_content || data.posts)) {
                // Use full content from posts, not the executive summary
                let fullContent = data.content || data.full_content || '';
                
                // If we have posts array, use the first post's content
                if ((!fullContent || fullContent.trim() === '') && data.posts && data.posts.length > 0) {
                    fullContent = data.posts.map(post => post.content || '').join('\n\n');
                }
                
                // Check if content is HTML
                const isHTML = /<[a-z][\s\S]*>/i.test(fullContent);
                
                // Format content appropriately
                let formattedContent = fullContent;
                if (!isHTML) {
                    formattedContent = fullContent.replace(/\n/g, '<br>');
                }
                
                const summaryTextEl = document.getElementById('summaryText');
                if (summaryTextEl) {
                    const contentStyle = isHTML 
                        ? 'line-height: 1.8; font-size: 16px; color: #212529; padding: 10px;'
                        : 'white-space: pre-wrap; line-height: 1.8; font-size: 16px; color: #212529; padding: 10px;';
                    
                    // Add header with metadata
                    const headerHtml = `
                        <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 2px solid #dee2e6;">
                            <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                                <span style="font-weight: 600; color: #212529;">${data.student || 'Unknown'}</span>
                                <span style="color: #6c757d; font-size: 14px;">HW ${data.homework || 'N/A'}  ${data.llm || 'Unknown LLM'}</span>
                                <span style="color: #868e96; font-size: 12px;">${data.post_count || 0} post(s)</span>
                            </div>
                        </div>
                    `;
                    
                    summaryTextEl.innerHTML = headerHtml + `<div class="ed-post-content" style="${contentStyle}">${formattedContent}</div>`;
                    console.log('Displayed full content, length:', fullContent.length, 'isHTML:', isHTML);
                }
                
                // Handle PDF display
                const pdfUrls = data.pdfUrls || (data.pdfUrl ? [data.pdfUrl] : []);
                const pdfViewerEl = document.getElementById('pdfViewer');
                if (pdfViewerEl) {
                    if (pdfUrls.length > 0) {
                        let pdfHtml = '';
                        if (pdfUrls.length === 1) {
                            pdfHtml = `<iframe src="${getEmbedUrl(pdfUrls[0])}" width="100%" height="600px" style="border: none;" allow="autoplay"></iframe>`;
                        } else {
                            pdfHtml = '<div style="margin-bottom: 15px;">';
                            pdfUrls.forEach((url, index) => {
                                pdfHtml += `<div style="margin-bottom: 10px;">
                                    <a href="${url}" target="_blank" style="color: #003262; font-weight: 600; text-decoration: none; padding: 8px 15px; background: #f8f9fa; border-radius: 4px; display: inline-block;">
                                        PDF ${index + 1}
                                    </a>
                                </div>`;
                            });
                            pdfHtml += '</div>';
                            pdfHtml += `<iframe src="${getEmbedUrl(pdfUrls[0])}" width="100%" height="600px" style="border: none;" allow="autoplay"></iframe>`;
                        }
                        pdfViewerEl.innerHTML = pdfHtml;
                    } else {
                        pdfViewerEl.innerHTML = `
                            <div style="text-align: center;">
                                <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="#003262" stroke-width="2">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                    <polyline points="14 2 14 8 20 8"></polyline>
                                </svg>
                                <p style="color: #003262; font-weight: 600; margin-top: 10px;">No PDF Available</p>
                                <p style="color: #6c757d; font-size: 14px;">${student} - Homework ${homework} - ${llm}</p>
                            </div>
                        `;
                    }
                }
            } else {
                const summaryTextEl = document.getElementById('summaryText');
                const pdfViewerEl = document.getElementById('pdfViewer');
                if (summaryTextEl) {
                    summaryTextEl.innerHTML = `
                        <p class="placeholder">No submission found for ${student} on Homework ${homework} using ${llm}.</p>
                        <p class="placeholder" style="margin-top: 10px; font-size: 14px;">Please check your API connection or verify the data exists in the database.</p>
                    `;
                }
                if (pdfViewerEl) {
                    pdfViewerEl.innerHTML = `
                        <div class="placeholder">
                            <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="#6c757d" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                            </svg>
                            <p>No PDF available</p>
                        </div>
                    `;
                }
                return true; // Still return true as the search was performed
            }
            return true; // Search was successful
        }

        async function applyFilters() {
            const participation = getSelectedValues('participation');
            const students = getSelectedValues('student');
            const homeworks = getSelectedValues('homework');
            const llms = getSelectedValues('llm');

            const activeTab = document.querySelector('.tab.active').textContent.trim();
            const isWordCloudTab = activeTab.includes('Word Cloud');
            
            // For Word Cloud tab, don't require student selection
            if (isWordCloudTab) {
                if (participation.length === 0 && homeworks.length === 0 && llms.length === 0) {
                    alert('Please select at least one filter option (Participation, Homework, or LLM Agent)');
                    return;
                }
            } else {
                if (participation.length === 0 && students.length === 0 && homeworks.length === 0 && llms.length === 0) {
                    alert('Please select at least one filter option');
                    return;
                }
            }
            
            // For Word Cloud tab, ignore student selection (pass empty array)
            const studentsToFilter = isWordCloudTab ? [] : students;
            
            // Always fetch posts (needed for both tabs)
            const posts = await fetchPosts(participation, studentsToFilter, homeworks, llms);
            
            // Update global postsData for filtering - fetch ALL posts to ensure dropdowns have complete data
            // This ensures all LLMs are available in the dropdown even if they're not in the current filter results
            try {
                const allPosts = await fetchPosts([], [], [], []);
                postsData = allPosts;
                // Only refresh dropdowns if we have new data - don't clear existing selections unnecessarily
                // The refresh interval will handle regular updates
            } catch (error) {
                console.error('Error fetching all posts:', error);
                // Fallback: just use the filtered posts
                postsData = posts;
            }
            
            // Display posts if on Posts tab
            if (activeTab.includes('Posts')) {
                displayPosts(posts);
            }
            
            // Generate word cloud and sentiment if on Word Cloud tab
            if (isWordCloudTab) {
                // Pass filtered posts to generate word cloud from actual content
                generateWordCloud(posts, llms);
                // Generate sentiment analysis from actual post content
                const sentimentResults = analyzeSentiment(posts, llms);
                displaySentiment(llms, sentimentResults);
            }
        }

        function displayPosts(posts) {
            const grid = document.getElementById('postsGrid');
            if (!grid) return;
            
            grid.innerHTML = '';
            
            if (!posts || posts.length === 0) {
                grid.innerHTML = '<p class="placeholder">No posts found matching the selected filters.</p>';
                return;
            }

            posts.forEach(post => {
                const card = document.createElement('div');
                card.className = 'post-card';
                card.style.cursor = 'pointer';
                card.onclick = (e) => {
                    // Don't navigate if clicking on the "View on Ed" link or any link
                    if (e.target.tagName === 'A' || e.target.closest('a')) {
                        return;
                    }
                    
                    // Navigate to executive summary page
                    navigateToPostSummary(post);
                };
                
                // Use participation_type field, not participation
                const participationType = post.participation_type || post.participation || 'A';
                const participationClass = participationType.toLowerCase();
                const participationLabel = participationType;
                
                // Build metadata string
                let metaInfo = [];
                if (post.post_number) metaInfo.push(`Post #${post.post_number}`);
                // Handle homework_number - show "Homework 0" for 0, not "unknown"
                if (post.homework_number !== null && post.homework_number !== undefined && post.homework_number !== '' && post.homework_number !== 'unknown') {
                    if (post.homework_number === 0 || post.homework_number === '0') {
                        metaInfo.push('HW 0');
                    } else {
                        metaInfo.push(`HW ${post.homework_number}`);
                    }
                }
                if (post.llm_agent) metaInfo.push(post.llm_agent);
                
                // Check for PDFs - try API data first, then extract from content
                let pdfUrls = post.pdf_urls || [];
                if (pdfUrls.length === 0 && (post.content || post.text)) {
                    pdfUrls = extractPdfsFromContent(post.content || post.text);
                }
                const hasPdf = pdfUrls.length > 0;
                // Store extracted PDFs back to post for later use
                if (hasPdf && (!post.pdf_urls || post.pdf_urls.length === 0)) {
                    post.pdf_urls = pdfUrls;
                }
                
                card.innerHTML = `
                    <h3>${post.title || 'Untitled Post'}</h3>
                    <div class="post-meta">
                        <p class="post-author">${post.author || 'Unknown'}</p>
                        <p class="participation-badge ${participationClass}">Participation ${participationLabel}</p>
                        ${hasPdf ? '<span style="color: #28a745; font-size: 15px; font-weight: 700;"> PDF</span>' : ''}
                    </div>
                    ${metaInfo.length > 0 ? `<p style="color: #495057; font-size: 15px; margin-bottom: 12px; font-weight: 500;">${metaInfo.join('  ')}</p>` : ''}
                    <p class="post-excerpt">${post.excerpt || post.content || 'No content available.'}</p>
                    <div style="display: flex; gap: 10px; margin-top: 12px; flex-wrap: wrap;">
                        ${post.url ? `<a href="${post.url}" target="_blank" onclick="event.stopPropagation();" style="color: #003262; font-size: 15px; font-weight: 600; text-decoration: none; padding: 6px 12px; background: #f8f9fa; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#f8f9fa'">View on Ed </a>` : ''}
                        <span style="color: #6c757d; font-size: 14px; font-style: italic; padding: 6px 0;">Click card to view summary & PDF</span>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // Convert file URLs to embeddable format
        function getEmbedUrl(url) {
            if (!url) return url;
            
            // Convert Google Drive URLs to preview/embed format
            // From: https://drive.google.com/file/d/FILE_ID/view?usp=sharing
            // To: https://drive.google.com/file/d/FILE_ID/preview
            if (url.includes('drive.google.com/file/d/')) {
                const match = url.match(/drive\.google\.com\/file\/d\/([^\/]+)/);
                if (match && match[1]) {
                    const fileId = match[1];
                    return `https://drive.google.com/file/d/${fileId}/preview`;
                }
            }
            
            return url;
        }

        function switchPdfView(pdfUrl) {
            // Update the PDF iframe with the new URL (convert to embed format)
            const iframe = document.getElementById('pdfIframe');
            if (iframe) {
                iframe.src = getEmbedUrl(pdfUrl);
            }
            
            // Update active state of PDF tab buttons
            document.querySelectorAll('.pdf-tab-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.style.background = '#f8f9fa';
            });
            
            // Find and activate the clicked button
            event.target.classList.add('active');
            event.target.style.background = '#FDB515';
            
            // Update download link
            const downloadLink = document.querySelector('#pdfViewer a[download]');
            if (downloadLink) {
                downloadLink.href = pdfUrl;
            }
        }

        // Common stop words to exclude from word cloud
        const STOP_WORDS = new Set([
            'the', 'a', 'an', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for', 'of', 'with',
            'by', 'from', 'up', 'about', 'into', 'through', 'during', 'before', 'after',
            'above', 'below', 'between', 'under', 'again', 'further', 'then', 'once',
            'here', 'there', 'when', 'where', 'why', 'how', 'all', 'each', 'few', 'more',
            'most', 'other', 'some', 'such', 'no', 'nor', 'not', 'only', 'own', 'same',
            'so', 'than', 'too', 'very', 's', 't', 'can', 'will', 'just', 'don', 'should',
            'now', 'i', 'me', 'my', 'myself', 'we', 'our', 'ours', 'ourselves', 'you',
            'your', 'yours', 'yourself', 'yourselves', 'he', 'him', 'his', 'himself',
            'she', 'her', 'hers', 'herself', 'it', 'its', 'itself', 'they', 'them',
            'their', 'theirs', 'themselves', 'what', 'which', 'who', 'whom', 'this',
            'that', 'these', 'those', 'am', 'is', 'are', 'was', 'were', 'be', 'been',
            'being', 'have', 'has', 'had', 'having', 'do', 'does', 'did', 'doing',
            'would', 'could', 'might', 'must', 'shall', 'if', 'as', 'because', 'while',
            'although', 'however', 'also', 'like', 'use', 'using', 'used', 'get', 'got',
            'make', 'made', 'one', 'two', 'first', 'way', 'even', 'new', 'want', 'since',
            'see', 'time', 'well', 'back', 'come', 'need', 'know', 'take', 'think', 'work',
            'nbsp', 'amp', 'lt', 'gt', 'quot', 'p', 'br', 'div', 'span', 'class', 'style',
            'http', 'https', 'www', 'com', 'org', 'edu', 'html', 'css', 'png', 'jpg'
        ]);

        function extractWordsFromContent(posts) {
            // Combine all post content
            let allText = '';
            posts.forEach(post => {
                const content = post.content || post.text || post.body || '';
                // Strip HTML tags
                const textOnly = content.replace(/<[^>]*>/g, ' ');
                allText += ' ' + textOnly;
            });
            
            // Clean and tokenize
            const words = allText.toLowerCase()
                .replace(/[^a-z\s]/g, ' ')  // Remove non-letters
                .split(/\s+/)
                .filter(word => word.length > 2 && !STOP_WORDS.has(word));
            
            // Count word frequencies
            const wordCount = {};
            words.forEach(word => {
                wordCount[word] = (wordCount[word] || 0) + 1;
            });
            
            // Sort by frequency and take top words
            const sortedWords = Object.entries(wordCount)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 50);  // Top 50 words
            
            // Calculate sizes based on frequency
            if (sortedWords.length === 0) {
                return [];
            }
            
            const maxCount = sortedWords[0][1];
            const minSize = 12;
            const maxSize = 60;
            
            return sortedWords.map(([text, count]) => ({
                text: text,
                size: minSize + (count / maxCount) * (maxSize - minSize),
                count: count
            }));
        }

        function generateWordCloud(posts, llms) {
            const element = document.getElementById('wordcloud');
            element.innerHTML = '';
            
            if (!posts || posts.length === 0) {
                element.innerHTML = '<div class="placeholder" style="display: flex; align-items: center; justify-content: center; height: 300px;"><p>No posts available to generate word cloud</p></div>';
                return;
            }
            
            // Extract words from actual post content
            const words = extractWordsFromContent(posts);
            
            if (words.length === 0) {
                element.innerHTML = '<div class="placeholder" style="display: flex; align-items: center; justify-content: center; height: 300px;"><p>No meaningful words found in post content</p></div>';
                return;
            }
            
            console.log('Word cloud data:', words.slice(0, 10));
            
            const width = element.offsetWidth || 800;
            const height = 500;

            const berkeleyColors = ['#003262', '#3B7EA1', '#FDB515', '#ED4E33', '#00B0DA'];

            const layout = d3.layout.cloud()
                .size([width, height])
                .words(words)
                .padding(5)
                .rotate(() => (Math.random() > 0.5 ? 0 : 90 * (Math.random() > 0.5 ? 1 : -1)))
                .fontSize(d => d.size)
                .on('end', draw);

            layout.start();

            function draw(words) {
                const svg = d3.select('#wordcloud').append('svg')
                    .attr('width', width)
                    .attr('height', height)
                    .append('g')
                    .attr('transform', `translate(${width/2},${height/2})`);

                svg.selectAll('text')
                    .data(words)
                    .enter().append('text')
                    .style('font-size', d => `${d.size}px`)
                    .style('fill', (d, i) => berkeleyColors[i % berkeleyColors.length])
                    .style('font-family', 'Noto Serif, serif')
                    .style('font-weight', '600')
                    .style('cursor', 'pointer')
                    .attr('text-anchor', 'middle')
                    .attr('transform', d => `translate(${d.x},${d.y}) rotate(${d.rotate})`)
                    .text(d => d.text)
                    .on('mouseover', function(event, d) {
                        d3.select(this).style('opacity', 0.7);
                    })
                    .on('mouseout', function(event, d) {
                        d3.select(this).style('opacity', 1);
                    })
                    .append('title')
                    .text(d => `${d.text}: ${d.count} occurrences`);
            }
        }

        // Simple sentiment analysis using word lists
        const POSITIVE_WORDS = new Set([
            'good', 'great', 'excellent', 'amazing', 'wonderful', 'fantastic', 'awesome',
            'helpful', 'useful', 'effective', 'efficient', 'correct', 'accurate', 'perfect',
            'best', 'better', 'improved', 'success', 'successful', 'solved', 'solution',
            'easy', 'simple', 'clear', 'understand', 'understood', 'learned', 'learning',
            'fast', 'quick', 'efficient', 'productive', 'save', 'saved', 'saving', 'time',
            'love', 'like', 'enjoy', 'enjoyed', 'appreciate', 'thanks', 'thank', 'grateful',
            'impressive', 'remarkable', 'outstanding', 'exceptional', 'superb', 'brilliant',
            'insightful', 'valuable', 'beneficial', 'advantage', 'positive', 'recommend',
            'innovative', 'creative', 'smart', 'intelligent', 'clever', 'intuitive',
            'reliable', 'consistent', 'thorough', 'comprehensive', 'detailed', 'precise',
            'elegant', 'clean', 'nice', 'pretty', 'beautiful', 'neat', 'organized',
            'works', 'working', 'worked', 'fixed', 'fix', 'resolved', 'helped', 'assist'
        ]);

        const NEGATIVE_WORDS = new Set([
            'bad', 'poor', 'terrible', 'awful', 'horrible', 'wrong', 'incorrect', 'error',
            'mistake', 'bug', 'bugs', 'fail', 'failed', 'failure', 'problem', 'problems',
            'issue', 'issues', 'difficult', 'hard', 'complex', 'complicated', 'confusing',
            'confused', 'frustrating', 'frustrated', 'annoying', 'annoyed', 'slow', 'slower',
            'broken', 'break', 'crash', 'crashed', 'stuck', 'block', 'blocked', 'missing',
            'lack', 'lacking', 'incomplete', 'unclear', 'vague', 'ambiguous', 'useless',
            'waste', 'wasted', 'unhelpful', 'disappointed', 'disappointing', 'unexpected',
            'unfortunately', 'sadly', 'worse', 'worst', 'hate', 'dislike', 'avoid',
            'unreliable', 'inconsistent', 'inaccurate', 'misleading', 'false', 'fake',
            'struggle', 'struggling', 'struggled', 'trouble', 'painful', 'tedious'
        ]);

        function analyzeSentiment(posts, llms) {
            const sentimentByLLM = {};
            
            // Group posts by LLM
            const postsByLLM = {};
            posts.forEach(post => {
                const llm = post.llm_agent || 'Unknown';
                if (!postsByLLM[llm]) {
                    postsByLLM[llm] = [];
                }
                postsByLLM[llm].push(post);
            });
            
            // Analyze sentiment for each LLM
            Object.entries(postsByLLM).forEach(([llm, llmPosts]) => {
                let positiveCount = 0;
                let negativeCount = 0;
                let totalWords = 0;
                
                llmPosts.forEach(post => {
                    const content = (post.content || post.text || post.body || '').toLowerCase();
                    // Strip HTML and get words
                    const textOnly = content.replace(/<[^>]*>/g, ' ');
                    const words = textOnly.replace(/[^a-z\s]/g, ' ').split(/\s+/).filter(w => w.length > 2);
                    
                    words.forEach(word => {
                        if (POSITIVE_WORDS.has(word)) positiveCount++;
                        if (NEGATIVE_WORDS.has(word)) negativeCount++;
                        totalWords++;
                    });
                });
                
                // Calculate sentiment score (-1 to 1)
                const totalSentimentWords = positiveCount + negativeCount;
                let score = 0;
                let sentiment = 'neutral';
                
                if (totalSentimentWords > 0) {
                    score = (positiveCount - negativeCount) / totalSentimentWords;
                    // Normalize to 0-1 range for display
                    const normalizedScore = (score + 1) / 2;
                    
                    if (score > 0.2) {
                        sentiment = 'positive';
                    } else if (score < -0.2) {
                        sentiment = 'negative';
                    } else {
                        sentiment = 'neutral';
                    }
                    
                    sentimentByLLM[llm] = {
                        score: normalizedScore,
                        sentiment: sentiment,
                        positiveWords: positiveCount,
                        negativeWords: negativeCount,
                        postCount: llmPosts.length,
                        totalWords: totalWords
                    };
                } else {
                    sentimentByLLM[llm] = {
                        score: 0.5,
                        sentiment: 'neutral',
                        positiveWords: 0,
                        negativeWords: 0,
                        postCount: llmPosts.length,
                        totalWords: totalWords
                    };
                }
            });
            
            console.log('Sentiment analysis results:', sentimentByLLM);
            return sentimentByLLM;
        }

        function displaySentiment(selectedLLMs, sentimentDataParam = null) {
            const grid = document.getElementById('sentimentGrid');
            grid.innerHTML = '';

            const dataToUse = sentimentDataParam || sentimentData;
            const dataToDisplay = selectedLLMs.length > 0 
                ? Object.entries(dataToUse).filter(([llm]) => selectedLLMs.includes(llm))
                : Object.entries(dataToUse);

            if (dataToDisplay.length === 0) {
                grid.innerHTML = '<p class="placeholder">No sentiment data available. Select filters and click Search to analyze posts.</p>';
                return;
            }

            dataToDisplay.forEach(([llm, data]) => {
                const card = document.createElement('div');
                card.className = `sentiment-card ${data.sentiment || 'neutral'}`;
                
                // Get sentiment emoji
                let emoji = '';
                if (data.sentiment === 'positive') emoji = '';
                else if (data.sentiment === 'negative') emoji = '';
                
                // Calculate percentage
                const percentage = ((data.score || 0.5) * 100).toFixed(0);
                
                card.innerHTML = `
                    <div class="llm-name">${llm}</div>
                    <div class="sentiment-score">${emoji} ${percentage}%</div>
                    <div style="color: #6c757d; font-size: 14px; text-transform: capitalize; margin-bottom: 8px;">${data.sentiment || 'neutral'}</div>
                    <div style="font-size: 12px; color: #868e96; border-top: 1px solid #dee2e6; padding-top: 8px; margin-top: 8px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                            <span style="color: #28a745;"> ${data.positiveWords || 0} positive</span>
                            <span style="color: #dc3545;"> ${data.negativeWords || 0} negative</span>
                        </div>
                        <div> ${data.postCount || 0} post${data.postCount !== 1 ? 's' : ''} analyzed</div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }
    </script>
</body>
</html>